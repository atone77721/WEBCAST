name: Generate PixelSports M3U

on:
  schedule:
    - cron: "0 */8 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: pixelsports-m3u
  cancel-in-progress: true

jobs:
  build-m3u:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repo (with write token)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install system dependencies for Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ca-certificates \
            fonts-liberation \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libcups2 \
            libdrm2 \
            libgbm1 \
            libgtk-3-0 \
            libnspr4 \
            libnss3 \
            libx11-xcb1 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            xdg-utils

      - name: Install JS dependencies
        run: |
          npm install puppeteer

      - name: Decode hidden pixelsports.js
        run: |
          echo "${{ secrets.PIXELSPORT_SCRIPT }}" | base64 --decode > pixelsports.js

      - name: Run JS scraper to generate M3U8
        run: |
          node pixelsports.js

      - name: Cleanup pixelsports.js
        if: always()
        run: |
          rm -f pixelsports.js

      - name: Upload artifact (Pixelsports.m3u8)
        uses: actions/upload-artifact@v4
        with:
          name: Pixelsports
          path: Pixelsports.m3u8
          if-no-files-found: error

      - name: Commit & push updated playlist
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add Pixelsports.m3u8
          git commit -m "Auto-update Pixelsports.m3u8" || echo "No changes"
          git pull --rebase origin main
          git push
